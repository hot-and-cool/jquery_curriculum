<!doctype html>
<html>
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="format-detection" content="telephone=no">
    <title>jQuery</title>
    <link rel="stylesheet" href="../../common/css/reset.css">
    <link rel="stylesheet" href="../../common/css/base.css">
    <link rel="stylesheet" href="./css/style.css">
  </head>
  <body>
    <div class="wrap">
      <div class="container">
        <div class="header">
          <p class="header__title">Search Books!</p>
        </div>
        <div class="search">
          <div class="search__text">
            <input type="text" id="js-search-word" class="search__text__input" placeholder="検索する">
          </div>
          <button id="js-search-button" class="search__btn">検索する</button>
        </div>
        <!-- ここに検索結果がないときのmessageを入れる -->
        <ul class="lists"></ul>
      </div>
    </div>
    <script src="../../common/js/jquery.js"></script>
    <script>
    $(function() {
      //関数化
      function addBooks(data) {
        var books = data.Items; 
        var html = ""; //空のテンプレートを用意
        $.each(books, function(index,book) {
          html +=` <li class='lists__item'>
                    <div class='lists__item__inner'>
                      <a href='${book.Item.itemUrl}' class='lists__item__link' target='_blank'>
                        <img src='${book.Item.largeImageUrl}' class='lists__item__img' alt=''>
                        <p class='lists__item__detail'>作品名： ${book.Item.title}</p>
                        <p class='lists__item__detail'>作者　： ${book.Item.author}</p>
                        <p class='lists__item__detail'>出版社： ${book.Item.publisherName}</p>
                      </a>
                    </div>
                  </li>`;
          //空のテンプレートにリストを繰り返し追加。（１回目<li A> ２回目<li A><li B> ・・・・20回ループ）
        });
        $('.lists').prepend(html); //できたテンプレート（<li>*20）を挿入
      }

      function emptyMessage() {
        $('.message').empty();
      } //検索０メッセージを空にする

      function addMessage() {
        var noneResult = `<div class='message'>検索結果が見つかりませんでした。<br>別のキーワードで検索して下さい。</div>`;
        $('.search').after(noneResult);
      } //検索結果のメッセージを挿入

      function emptyBookLists() {
        $('.lists').empty(); //検索ボタンを押したら.lists内を空にする
      }

      function changeWord (){
        $('.search__text__input').change(function(){
          pageNum = 0;
          // wordが変わったらpageをリセット
        });
        emptyBookLists();
      }

      function addError(data) {
        var errors = data.responseJSON;
        console.log(data)
        var buildErrorMessage = `<div class='message'>エラー名:${errors.error}<br>エラー内容:${errors.error_description}</div>`;
        $('.search').after(buildErrorMessage);
      } //エラー文出す

      var pageNum = 0; //クリックするたびにpage数を増やすためclickイベントの外に置く

      $('#js-search-button').click(function() {
        var word = $('.search__text__input').val();
        pageNum++; //クリックするたびにページを増やす。今のままだと全部(wordを変えたときに値をリセットしたい)
        $.ajax({
          url: 'https://app.rakuten.co.jp/services/api/BooksTotal/Search/20130522',
          type: 'GET',
          datatype: 'json', //オブジェクトデータ形式。キーとバリューを持ったハッシュでデータが渡される
          data: {
            keyword: word,
            hits: 20,
            page: pageNum,
            applicationId: '1019399324990976605',
            booksGenreId: '001'
          },
        }).done(function(data) {
          console.log(data);
          console.log(pageNum);
          var count = data.count;
          if (count > 0) {
              emptyMessage(); //０件メッセージ消す
              changeWord(); //検索wordが変更したらページをリセットさせ本を消す
              addBooks(data); //本を表示
          } else { //表示件数が０のとき
            emptyMessage();
            addMessage();
            // changeWord();
          }
        }).fail(function(data) {
          emptyMessage();
          if (navigator.onLine === false){
            $('.search').after("<p class='message'>ネットワークに接続されておりません</p>");
            return;
          }
          addError(data);
          changeWord(); //これがないとオンに復帰したときクリックした回数＝ページ数が残ってしまう
        });
      });
      // addEventListener=jqeryのonメソッド。イベントを指定できる。
      // オンラインになったら呼び出す
      window.addEventListener("online", function() {
        alert("ネットワークに接続しています");
      }, false);
      // オフラインになったら呼び出す
      window.addEventListener("offline", function() {
        alert("ネットワーク接続が途切れました");
      }, false);
    });
    </script>
  </body>
</html>
